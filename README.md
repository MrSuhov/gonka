# Gonka Node Deployment Automation

Автоматизированный скрипт для развёртывания ноды Gonka AI на удалённом сервере.

## Описание

`mitch_help.sh` - это bash-скрипт, который в полностью автоматическом режиме выполняет все шаги из инструкции [Full node hyperstack.md](docs/Full%20node%20hyperstack.md) для развёртывания Gonka ноды.

**Особенности:**
- ✅ Запускается локально, все команды выполняются на удалённом сервере через SSH
- ✅ Идемпотентный (можно запускать несколько раз безопасно)
- ✅ Детальное логирование всех операций с временными метками
- ✅ Автоматическая проверка уже выполненных шагов
- ✅ Комплексная валидация параметров перед стартом
- ✅ Финальная проверка работоспособности и отчёт

## Предварительные требования

### На локальной машине:

1. **SSH доступ** к удалённому серверу
2. Утилиты: `ssh`, `scp` (обычно уже установлены)
3. **Холодный кошелёк** уже создан локально с помощью `inferenced`:
   ```bash
   ./inferenced keys add <node-name> --keyring-backend file
   ```
   Сохраните вывод (seed и public key) в безопасное место!

### На удалённом сервере (должно быть настроено хостером):

1. Ubuntu 22.04/24.04 LTS
2. NVIDIA GPU (H100/A100)
3. Docker и Docker Compose установлены
4. CUDA 12.6-12.9 установлена
5. Volume подключён (обычно `/dev/vdc`)
6. Firewall настроен (порты 5000, 8000, 26657 открыты)
7. Public IP адрес назначен

## Быстрый старт

### 1. Подготовка конфигурации

Скопируйте пример конфига и заполните параметры:

```bash
cp nodes/node1.conf.example nodes/node1.conf
nano nodes/node1.conf
```

**Обязательные параметры в конфиге:**
- `SERVER_IP` - IP адрес вашего сервера
- `SSH_USER` - SSH пользователь (обычно `ubuntu`)
- `KEY_NAME` - имя ноды (как хостер сгенерировал)
- `KEYRING_PASSWORD` - рандомный пароль для warm wallet (минимум 8 символов)
- `ACCOUNT_PUBKEY` - public key из вашего холодного кошелька
- `MODEL_NAME` - модель для скачивания (`Qwen/Qwen3-32B-FP8` для 1 GPU)
- `NODE_CONFIG_PROFILE` - профиль конфигурации (`x1` для 1 GPU, `x8` для 8 GPU)

### 2. Сделайте скрипт исполняемым

```bash
chmod +x mitch_help.sh
```

### 3. Запустите развёртывание

```bash
./mitch_help.sh nodes/node1.conf
```

Скрипт покажет все параметры и попросит подтверждение. Проверьте внимательно и введите `yes`.

### 4. После завершения

Скрипт выполнит все фазы автоматически и в конце покажет отчёт с полезными ссылками.

**ВАЖНО:** После успешного деплоя выполните локально команду grant для выдачи прав:

```bash
./inferenced tx inference grant-ml-ops-permissions \
    <cold-key-name> \
    <warm-wallet-address> \
    --from <cold-key-name> \
    --keyring-backend file \
    --gas 2000000 \
    --node http://node2.gonka.ai:8000/chain-rpc/
```

Где:
- `<cold-key-name>` - имя ключа из local_key.txt
- `<warm-wallet-address>` - адрес из `nodes/<KEY_NAME>/warm_address.txt`

## Структура директорий

После запуска будет создана следующая структура:

```
gonka/
├── mitch_help.sh              # Основной скрипт
├── nodes/                     # Конфигурации и выходы нод
│   ├── node1.conf.example    # Пример конфига
│   ├── node1.conf            # Ваш конфиг (создаёте вручную)
│   └── quick-newton/         # Директория для конкретной ноды (создаётся автоматически)
│       ├── config.env        # Созданный config.env
│       ├── node-config.json  # Созданный node-config.json
│       ├── warm_key.txt      # Вывод создания warm wallet (SEED!)
│       ├── warm_address.txt  # Адрес warm wallet
│       ├── registration.txt  # Вывод регистрации в блокчейне
│       ├── volume.txt        # UUID volume
│       └── verification.txt  # Результаты проверок
└── logs/                      # Логи выполнения
    ├── quick-newton_2025-12-24_14-30-15.log  # Детальный лог
    └── quick-newton_latest.log               # Симлинк на последний лог
```

## Фазы выполнения

Скрипт выполняет следующие фазы:

### Фаза 0: Валидация и подтверждение
- Проверка всех обязательных параметров
- Проверка SSH connectivity
- Вывод параметров на экран
- Запрос подтверждения от пользователя

### Фаза 1: Подготовка сервера
- Добавление SSH ключей админов
- Монтирование Volume (/dev/vdc)
- Установка и запуск Prometheus

### Фаза 2: Установка Gonka и моделей
- Клонирование репозитория Gonka
- Установка pipx и huggingface_hub
- Скачивание ML модели (может занять время!)

### Фаза 3: Конфигурация
- Создание config.env
- Создание node-config.json
- Загрузка конфигов на сервер

### Фаза 4: Запуск базовых сервисов
- Запуск контейнеров tmkms и node
- Создание warm wallet
- Регистрация участника в блокчейне

### Фаза 5: Настройка блокчейна
- Настройка persistent_peers
- Настройка pruning
- Перезапуск node

### Фаза 6: Финальный запуск
- Запуск всех сервисов включая MLNode

### Фаза 7: Проверка и отчёт
- Проверка API endpoints
- Проверка CUDA
- Проверка логов
- Генерация финального отчёта

## Логирование

Скрипт создаёт детальные логи всех операций:

- Каждый запуск создаёт новый лог-файл с timestamp
- Все команды и их вывод записываются в лог
- Цветной вывод в консоль для удобства
- Симлинк `*_latest.log` всегда указывает на последний лог

Типы сообщений:
- `[INFO]` - информационные сообщения
- `[CHECK]` - проверка состояния
- `[EXEC]` - выполнение команды
- `[OK]` - успешное выполнение
- `[SKIP]` - шаг пропущен (уже выполнен)
- `[WARN]` - предупреждение
- `[ERROR]` - ошибка (останавливает выполнение)

## Проверка работоспособности

После завершения скрипта проверьте:

1. **Dashboard ноды:** `http://<SERVER_IP>:8000/`
2. **Chain RPC:** `http://<SERVER_IP>:26657/status`
3. **Регистрация участника:** `http://node2.gonka.ai:8000/v1/participants/<warm-address>`
4. **Трекеры:**
   - http://34.60.64.109/
   - https://tracker.gonka.hyperfusion.io/
   - https://gonkahub.com/network

## Устранение проблем

### Скрипт останавливается с ошибкой

1. Проверьте лог-файл: `logs/<KEY_NAME>_latest.log`
2. Найдите строку с `[ERROR]`
3. Исправьте проблему
4. Запустите скрипт снова (он пропустит уже выполненные шаги)

### CUDA не работает после деплоя

Выполните на сервере:

```bash
cd /mnt/ssd/gonka/deploy/join
sudo -E docker compose -f docker-compose.mlnode.yml up -d --force-recreate
```

Или просто перезагрузите сервер.

### Нода не появляется в трекерах

1. Проверьте, что выполнена команда `grant` локально
2. Дождитесь начала следующей эпохи
3. Проверьте логи контейнеров на сервере:
   ```bash
   cd /mnt/ssd/gonka/deploy/join
   sudo docker compose logs api node mlnode --tail=100
   ```

## Повторный запуск

Скрипт идемпотентный - можно запускать повторно:

- Уже выполненные шаги будут пропущены (`[SKIP]`)
- Будут выполнены только недостающие шаги
- Безопасно для уже работающих нод

## Полезные команды

### Проверка статуса на сервере

```bash
# Логи контейнеров
cd /mnt/ssd/gonka/deploy/join
sudo docker compose logs -f

# Статус контейнеров
sudo docker compose ps

# CUDA проверка
sudo docker exec <mlnode-container> nvidia-smi

# Локальные API проверки
curl http://localhost:8080/health | jq
curl http://localhost:9200/admin/v1/setup/report | jq
```

## Структура конфигурационного файла

Подробности см. в [nodes/node1.conf.example](nodes/node1.conf.example)

## Связанные файлы

- [Full node hyperstack.md](docs/Full%20node%20hyperstack.md) - оригинальная инструкция
- [CLAUDE.md](CLAUDE.md) - контекст для Claude Code

## Поддержка

- Discord Gonka: https://discord.gg/gonka
- Twitter/X: https://x.com/gonka_ai
- Официальная дока: https://gonka.ai/host/quickstart/

## Лицензия

Этот скрипт создан для автоматизации развёртывания Gonka нод согласно официальной документации.
