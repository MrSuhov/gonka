# Workflow скрипта mitch_help.sh

## Общая схема

```
┌─────────────────────────────────────────────────────────────────┐
│                      ЛОКАЛЬНАЯ МАШИНА                           │
│                                                                 │
│  ┌──────────────────────────────────────────────────────┐     │
│  │  1. Запуск: ./mitch_help.sh nodes/node1.conf         │     │
│  └──────────────────────────────────────────────────────┘     │
│                            │                                   │
│                            ▼                                   │
│  ┌──────────────────────────────────────────────────────┐     │
│  │  2. Загрузка конфига + валидация параметров          │     │
│  │     - Проверка обязательных полей                    │     │
│  │     - Проверка форматов (IP, пароли, URLs)           │     │
│  │     - Проверка SSH connectivity                      │     │
│  └──────────────────────────────────────────────────────┘     │
│                            │                                   │
│                            ▼                                   │
│  ┌──────────────────────────────────────────────────────┐     │
│  │  3. Вывод параметров на экран                        │     │
│  │     → Запрос подтверждения (yes/no)                  │     │
│  └──────────────────────────────────────────────────────┘     │
│                            │                                   │
│                            ▼                                   │
│         ┌──────────────────────────────────────┐              │
│         │    Пользователь вводит "yes"         │              │
│         └──────────────────────────────────────┘              │
│                            │                                   │
└────────────────────────────┼───────────────────────────────────┘
                             │
                             │ SSH Connection
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                      УДАЛЁННЫЙ СЕРВЕР                           │
│                                                                 │
│  ╔═══════════════════════════════════════════════════════════╗ │
│  ║ ФАЗА 1: Подготовка сервера                                ║ │
│  ╚═══════════════════════════════════════════════════════════╝ │
│    - Добавление SSH ключей админов                            │
│    - Форматирование и монтирование /dev/vdc → /mnt/ssd        │
│    - Добавление в /etc/fstab                                  │
│    - Установка Prometheus (git clone + docker compose)        │
│                                                                 │
│  ╔═══════════════════════════════════════════════════════════╗ │
│  ║ ФАЗА 2: Gonka и модели                                    ║ │
│  ╚═══════════════════════════════════════════════════════════╝ │
│    - git clone https://github.com/gonka-ai/gonka.git          │
│    - Создание /mnt/ssd/hf для моделей                         │
│    - Установка pipx + huggingface_hub                         │
│    - Скачивание модели (может занять 10-30 минут!)           │
│                                                                 │
│  ╔═══════════════════════════════════════════════════════════╗ │
│  ║ ФАЗА 3: Конфигурация                                      ║ │
│  ╚═══════════════════════════════════════════════════════════╝ │
│    ┌─────────────────────────────────────────────┐            │
│    │  Локально создаются:                        │            │
│    │    - config.env (переменные окружения)      │            │
│    │    - node-config.json (параметры ML)        │            │
│    └─────────────────────────────────────────────┘            │
│              │                                                 │
│              ▼ (scp upload)                                    │
│    /mnt/ssd/gonka/deploy/join/config.env                      │
│    /mnt/ssd/gonka/deploy/join/node-config.json                │
│                                                                 │
│  ╔═══════════════════════════════════════════════════════════╗ │
│  ║ ФАЗА 4: Базовые сервисы                                   ║ │
│  ╚═══════════════════════════════════════════════════════════╝ │
│    - docker compose up tmkms node -d                          │
│    - Создание warm wallet (inferenced keys add)              │
│    - Регистрация в блокчейне (register-new-participant)       │
│                                                                 │
│       Вывод сохраняется локально:                             │
│         ├── warm_key.txt (SEED - ВАЖНО!)                      │
│         ├── warm_address.txt                                  │
│         └── registration.txt                                  │
│                                                                 │
│  ╔═══════════════════════════════════════════════════════════╗ │
│  ║ ФАЗА 5: Настройка блокчейна                               ║ │
│  ╚═══════════════════════════════════════════════════════════╝ │
│    - Редактирование .inference/config/config.toml             │
│      (persistent_peers)                                       │
│    - Редактирование .inference/config/app.toml                │
│      (pruning настройки)                                      │
│    - Перезапуск node контейнера                               │
│                                                                 │
│  ╔═══════════════════════════════════════════════════════════╗ │
│  ║ ФАЗА 6: Финальный запуск                                  ║ │
│  ╚═══════════════════════════════════════════════════════════╝ │
│    - docker compose -f docker-compose.yml \                   │
│                     -f docker-compose.mlnode.yml up -d        │
│                                                                 │
│    Запущенные контейнеры:                                     │
│      ├── tmkms (криптография)                                 │
│      ├── node (блокчейн нода)                                 │
│      ├── api (REST API)                                       │
│      └── mlnode (ML инференс)                                 │
│                                                                 │
│  ╔═══════════════════════════════════════════════════════════╗ │
│  ║ ФАЗА 7: Проверки                                          ║ │
│  ╚═══════════════════════════════════════════════════════════╝ │
│    ✓ Participant API (node2.gonka.ai:8000/v1/participants)   │
│    ✓ Node RPC (SERVER_IP:26657/status)                       │
│    ✓ Dashboard (SERVER_IP:8000/)                             │
│    ✓ CUDA availability (nvidia-smi в mlnode)                 │
│    ✓ PyTorch CUDA (torch.cuda.is_available())                │
│    ✓ Логи на ошибки                                          │
│                                                                 │
│       Результаты → verification.txt (локально)                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                    ФИНАЛЬНЫЙ ОТЧЁТ                              │
│                                                                 │
│  ✅ Deployment completed successfully                          │
│  📝 Все важные файлы сохранены в nodes/<KEY_NAME>/             │
│  📊 Полный лог в logs/<KEY_NAME>_timestamp.log                 │
│  🔗 Полезные ссылки для проверки                               │
│                                                                 │
│  ⚠️  ВАЖНО: Выполните команду grant локально!                  │
└─────────────────────────────────────────────────────────────────┘
```

## Автоматическое пропускание шагов

Скрипт проверяет состояние и пропускает уже выполненные шаги:

```
CHECK → Уже сделано? → [SKIP] Пропускаем
         │
         ▼ Нет
      [EXEC] Выполняем
         │
         ▼
      [OK] Готово
```

## Обработка ошибок

```
[EXEC] Команда
   │
   ├─→ Успех → [OK] → Продолжаем
   │
   └─→ Ошибка → [ERROR] → Логируем → STOP (exit 1)
```

## Логирование

Каждая операция логируется:

```
[2025-12-24 14:30:15] [CHECK] Checking SSH connectivity...
[2025-12-24 14:30:16] [OK] SSH connection successful
[2025-12-24 14:30:17] [EXEC] Remote: lsblk | grep vdc
[2025-12-24 14:30:18] [OUTPUT] /dev/vdc  1.8T  ...
```

Уровни логов:
- `INFO` - информация
- `CHECK` - проверка состояния
- `EXEC` - выполнение команды
- `OK` - успех
- `SKIP` - пропущено (уже сделано)
- `WARN` - предупреждение
- `ERROR` - критическая ошибка

## Созданные файлы

### Локально (nodes/<KEY_NAME>/)

```
nodes/quick-newton/
├── config.env              ← Конфиг для docker compose
├── node-config.json        ← Параметры ML модели
├── warm_key.txt            ← SEED теплого кошелька (ВАЖНО!)
├── warm_address.txt        ← Адрес теплого кошелька
├── registration.txt        ← Вывод регистрации
├── volume.txt              ← UUID volume
└── verification.txt        ← Результаты проверок
```

### На сервере

```
/mnt/ssd/
├── hf/                     ← Модели Hugging Face
│   └── hub/
│       └── models--Qwen--Qwen3-32B-FP8/
├── gonka/                  ← Gonka репозиторий
│   └── deploy/join/
│       ├── config.env
│       ├── node-config.json
│       ├── .env
│       ├── .inference/     ← Данные блокчейна
│       │   ├── config/
│       │   │   ├── config.toml
│       │   │   └── app.toml
│       │   └── data/       ← Chain data (растёт)
│       └── docker-compose.yml
└── prometheus/             ← Мониторинг
```

## Время выполнения (примерно)

- Фаза 0: 10 сек (валидация)
- Фаза 1: 2-3 мин (подготовка сервера)
- Фаза 2: 10-30 мин (скачивание модели!)
- Фаза 3: 30 сек (конфигурация)
- Фаза 4: 2-3 мин (запуск и регистрация)
- Фаза 5: 1 мин (настройка блокчейна)
- Фаза 6: 3-5 мин (запуск всех сервисов)
- Фаза 7: 1-2 мин (проверки)

**Итого: 20-45 минут** (зависит от скорости интернета и сервера)

## После деплоя

### ОБЯЗАТЕЛЬНО выполнить локально:

```bash
./inferenced tx inference grant-ml-ops-permissions \
    <cold-key-name> \
    <warm-wallet-address> \
    --from <cold-key-name> \
    --keyring-backend file \
    --gas 2000000 \
    --node http://node2.gonka.ai:8000/chain-rpc/
```

### Мониторинг

- Дождаться начала эпохи (проверить трекеры)
- Нода появится в трекерах
- Начнёт получать задачи и зарабатывать токены GNK
